<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>ReciclaF치cil - Registrar Descarte</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <header class="topo">
        <h1 class="titulo-principal"><a href="index.html" class="link-titulo">ReciclaF치cil</a></h1>
        <nav class="menu-superior">
            <a href="perfil.html" class="link-menu">In칤cio</a>
            <a href="registro.html" class="link-menu">Registrar Descarte</a>
            <a href="gamificacao.html" class="link-menu">Pontua칞칚o</a>
            <a href="mapa.html" class="link-menu">Pontos de descarte</a>
            <a href="guia.html" class="link-menu">Guia de descarte</a>
        </nav>
    </header>

    <main class="registro-main">
        <h2 class="titulo-pagina">Registrar Descarte</h2>
        <p class="subtitulo-pagina">Informe seu descarte e receba pontos</p>
    
        <div class="card-formulario">
            <form class="formulario-registro">
                <label class="label-registro" for="materialType">游닍 Tipo de material</label>
                <select id="materialType" class="input-registro">
                    <option value="">Selecione o tipo de material</option>
                    <option value="Pl치stico">Pl치stico</option>
                    <option value="Papel">Papel</option>
                    <option value="Alum칤nio">Alum칤nio</option>
                    <option value="Org칙nico">Org칙nico</option>
                    <option value="Vidro">Vidro</option>
                    <option value="Outros">Outros</option>
                </select>

                <label class="label-registro" for="weight">丘뒲잺 Peso (kg)</label>
                <input type="number" id="weight" class="input-registro" placeholder="Ex: 0.5, 2.0" step="0.1" min="0.1">
    
                <label class="label-registro" for="discardLocation">游늸 Local de Descarte</label>
                <input type="text" id="discardLocation" class="input-registro" placeholder="Ex: EcoPonto Vila Esperan칞a">
    
                <label class="label-registro" for="discardDate">游늰 Data</label>
                <input type="date" id="discardDate" class="input-registro">
    
                <button class="botao-registrar" type="button" id="registerDiscardButton">Registrar Descarte</button>
                <p id="discardMessage" style="color: red; margin-top: 10px;"></p>
            </form>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const registerDiscardButton = document.getElementById('registerDiscardButton');
            const discardMessage = document.getElementById('discardMessage');

            // Define os pontos por categoria de material
            const materialPoints = {
                "Pl치stico": 150,
                "Papel": 100,
                "Alum칤nio": 150,
                "Org칙nico": 50,
                "Vidro": 200,
                "Outros": 75 // Valor padr칚o para 'Outros'
            };

            registerDiscardButton.addEventListener('click', async () => {
                const userId = localStorage.getItem('loggedInUserId');
                if (!userId) {
                    discardMessage.style.color = 'red';
                    discardMessage.textContent = 'Voc칡 precisa estar logado para registrar um descarte.';
                    setTimeout(() => {
                        window.location.href = 'index.html'; // Redireciona para o login
                    }, 2000);
                    return;
                }

                const materialType = document.getElementById('materialType').value;
                const weight = document.getElementById('weight').value;
                const discardLocation = document.getElementById('discardLocation').value;
                const discardDate = document.getElementById('discardDate').value;

                // Valida칞칚o b치sica dos campos
                if (!materialType || !weight || !discardLocation || !discardDate) {
                    discardMessage.style.color = 'red';
                    discardMessage.textContent = 'Por favor, preencha todos os campos.';
                    return;
                }
                if (parseFloat(weight) <= 0) {
                    discardMessage.style.color = 'red';
                    discardMessage.textContent = 'O peso deve ser um valor positivo.';
                    return;
                }

                // Obt칠m os pontos baseados no tipo de material
                const pointsEarned = materialPoints[materialType] || 0; // Se a categoria n칚o estiver mapeada, pontos = 0

                const discardData = {
                    userId: userId,
                    item: materialType,
                    weight: parseFloat(weight),
                    location: discardLocation,
                    date: discardDate,
                    points: pointsEarned // Inclui os pontos no objeto de descarte
                };

                try {
                    const response = await fetch('http://18.222.5.253:5000/register-discard', { // Alterar URL para localhost
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(discardData)
                    });

                    const data = await response.json();

                    if (response.ok) {
                        discardMessage.style.color = 'green';
                        discardMessage.textContent = data.message;
                        // Limpar formul치rio ap칩s sucesso
                        document.getElementById('materialType').value = '';
                        document.getElementById('weight').value = '';
                        document.getElementById('discardLocation').value = '';
                        document.getElementById('discardDate').value = '';
                        
                        // Opcional: Redirecionar para a p치gina de perfil ou pontua칞칚o ap칩s um tempo
                        setTimeout(() => {
                            window.location.href = 'perfil.html'; 
                        }, 2000);

                    } else {
                        discardMessage.style.color = 'red';
                        discardMessage.textContent = data.message || 'Erro ao registrar descarte.';
                    }
                } catch (error) {
                    console.error('Erro na requisi칞칚o de registro de descarte:', error);
                    discardMessage.style.color = 'red';
                    discardMessage.textContent = 'N칚o foi poss칤vel conectar ao servidor para registrar o descarte.';
                }
            });
        });
    </script>
    
</body>
</html>
